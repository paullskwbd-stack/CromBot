# main.py
import os
import sqlite3
import random
from datetime import datetime, timedelta
import discord
from discord.ext import commands
from discord import app_commands
from keep_alive import keep_alive
import requests
from mcstatus import MinecraftServer

keep_alive()

TOKEN = os.getenv("DISCORD_TOKEN") or "DEIN_BOT_TOKEN_HIER"

# Config
import json
with open("config.json", "r") as f:
    config = json.load(f)

GUILD_ID = config.get("guild_id")
MC_IP = config.get("minecraft_ip")
MC_PORT = config.get("minecraft_port", 25565)

intents = discord.Intents.default()
intents.members = True
bot = commands.Bot(command_prefix="!", intents=intents)
tree = bot.tree
DB_PATH = "database.db"

# --------------- Datenbank -----------------
def get_db():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    c = conn.cursor()
    # Nutzer: Coins, XP, Level, Daily, Warns
    c.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        coins INTEGER DEFAULT 0,
        xp INTEGER DEFAULT 0,
        level INTEGER DEFAULT 1,
        last_daily TEXT,
        warns INTEGER DEFAULT 0
    )""")
    # Shop
    c.execute("""
    CREATE TABLE IF NOT EXISTS shop (
        item_id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT,
        price INTEGER,
        description TEXT
    )""")
    # Inventory
    c.execute("""
    CREATE TABLE IF NOT EXISTS inventory (
        user_id INTEGER,
        item_id INTEGER,
        amount INTEGER DEFAULT 0,
        PRIMARY KEY (user_id, item_id)
    )""")
    conn.commit()
    conn.close()

def ensure_shop_items():
    conn = get_db()
    c = conn.cursor()
    c.execute("SELECT COUNT(*) as cnt FROM shop")
    if c.fetchone()["cnt"] == 0:
        items = [
            ("VIP-Rolle", 500, "Gibt dir VIP (Demo)."),
            ("Mystery Box", 200, "√úberraschung!"),
            ("Nickname Change", 300, "√Ñndere deinen Nickname")
        ]
        c.executemany("INSERT INTO shop (name, price, description) VALUES (?, ?, ?)", items)
        conn.commit()
    conn.close()

def ensure_user(user_id):
    conn = get_db()
    c = conn.cursor()
    c.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    conn.commit()
    conn.close()

def add_coins(user_id, amount):
    ensure_user(user_id)
    conn = get_db()
    c = conn.cursor()
    c.execute("UPDATE users SET coins = coins + ? WHERE user_id = ?", (amount, user_id))
    conn.commit()
    conn.close()

def add_xp(user_id, amount):
    ensure_user(user_id)
    conn = get_db()
    c = conn.cursor()
    c.execute("UPDATE users SET xp = xp + ? WHERE user_id = ?", (amount, user_id))
    conn.commit()
    conn.close()

def get_user(user_id):
    conn = get_db()
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    r = c.fetchone()
    conn.close()
    return r

def xp_to_next(level):
    return 100 * level

# --------------- Events -----------------
@bot.event
async def on_ready():
    init_db()
    ensure_shop_items()
    if GUILD_ID:
        await bot.tree.sync(guild=discord.Object(id=GUILD_ID))
    else:
        await bot.tree.sync()
    print(f"CromBot online als {bot.user}")

@bot.event
async def on_member_join(member):
    try:
        if config.get("autorole_id"):
            role = member.guild.get_role(config["autorole_id"])
            if role:
                await member.add_roles(role)
        if config.get("welcome_channel_id"):
            ch = member.guild.get_channel(config["welcome_channel_id"])
            if ch:
                embed = discord.Embed(title=f"Willkommen {member.display_name}!",
                                      description="Viel Spa√ü auf dem Server üéâ",
                                      color=discord.Color.blurple())
                embed.set_thumbnail(url=member.display_avatar.url)
                await ch.send(embed=embed)
    except:
        pass

@bot.event
async def on_message(message):
    if message.author.bot:
        return
    xp = random.randint(5, 12)
    add_xp(message.author.id, xp)
    user = get_user(message.author.id)
    if user:
        if user["xp"] >= xp_to_next(user["level"]):
            conn = get_db()
            c = conn.cursor()
            c.execute("UPDATE users SET level = level + 1, xp = xp - ? WHERE user_id = ?", (xp_to_next(user["level"]), message.author.id))
            conn.commit()
            conn.close()
            await message.channel.send(f"üéâ {message.author.mention} hat Level {user['level']+1} erreicht!")
    await bot.process_commands(message)

# --------------- Moderation Commands -----------------
@tree.command(name="kick", description="Kickt einen User", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(user="Der User der gekickt werden soll", reason="Grund")
async def kick(interaction: discord.Interaction, user: discord.Member, reason: str = "Kein Grund angegeben"):
    if not interaction.user.guild_permissions.kick_members:
        return await interaction.response.send_message("‚ùå Du hast keine Berechtigung!", ephemeral=True)
    await user.kick(reason=reason)
    await interaction.response.send_message(f"‚úÖ {user.mention} wurde gekickt! Grund: {reason}")

@tree.command(name="ban", description="Bannt einen User", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(user="Der User der gebannt werden soll", reason="Grund")
async def ban(interaction: discord.Interaction, user: discord.Member, reason: str = "Kein Grund angegeben"):
    if not interaction.user.guild_permissions.ban_members:
        return await interaction.response.send_message("‚ùå Du hast keine Berechtigung!", ephemeral=True)
    await user.ban(reason=reason)
    await interaction.response.send_message(f"‚úÖ {user.mention} wurde gebannt! Grund: {reason}")

@tree.command(name="purge", description="L√∂scht Nachrichten", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(amount="Anzahl der Nachrichten")
async def purge(interaction: discord.Interaction, amount: int):
    if not interaction.user.guild_permissions.manage_messages:
        return await interaction.response.send_message("‚ùå Du hast keine Berechtigung!", ephemeral=True)
    deleted = await interaction.channel.purge(limit=amount)
    await interaction.response.send_message(f"‚úÖ {len(deleted)} Nachrichten gel√∂scht.", ephemeral=True)

@tree.command(name="warn", description="Verwarnt einen User", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(user="Der User der verwarnt werden soll", reason="Grund")
async def warn(interaction: discord.Interaction, user: discord.Member, reason: str = "Kein Grund angegeben"):
    ensure_user(user.id)
    conn = get_db()
    c = conn.cursor()
    c.execute("UPDATE users SET warns = warns + 1 WHERE user_id = ?", (user.id,))
    conn.commit()
    conn.close()
    await interaction.response.send_message(f"‚ö†Ô∏è {user.mention} wurde verwarnt! Grund: {reason}")

# --------------- Fun Commands -----------------
@tree.command(name="8ball", description="Frage den magischen W√ºrfel", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(question="Deine Frage")
async def eightball(interaction: discord.Interaction, question: str):
    answers = ["Ja", "Nein", "Vielleicht", "Definitiv", "Auf keinen Fall", "Ich wei√ü nicht"]
    await interaction.response.send_message(f"üé± {random.choice(answers)}")

@tree.command(name="coinflip", description="Wirf eine M√ºnze", guild=discord.Object(id=GUILD_ID))
async def coinflip(interaction: discord.Interaction):
    await interaction.response.send_message(f"ü™ô {'Kopf' if random.randint(0,1)==0 else 'Zahl'}")

@tree.command(name="love", description="Liebe zwischen zwei Usern", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(user1="Erster User", user2="Zweiter User")
async def love(interaction: discord.Interaction, user1: discord.Member, user2: discord.Member):
    percent = random.randint(0,100)
    await interaction.response.send_message(f"‚ù§Ô∏è Liebe zwischen {user1.display_name} und {user2.display_name}: {percent}%")

# --------------- Shop Commands -----------------
@tree.command(name="shop", description="Zeigt den Shop an", guild=discord.Object(id=GUILD_ID))
async def shop(interaction: discord.Interaction):
    conn = get_db()
    c = conn.cursor()
    c.execute("SELECT * FROM shop")
    items = c.fetchall()
    embed = discord.Embed(title="üõí Shop", color=discord.Color.green())
    for item in items:
        embed.add_field(name=f"{item['name']} ({item['price']} Coins)", value=item['description'], inline=False)
    await interaction.response.send_message(embed=embed)

@tree.command(name="buy", description="Kauft ein Item aus dem Shop", guild=discord.Object(id=GUILD_ID))
@app_commands.describe(item_name="Name des Items")
async def buy(interaction: discord.Interaction, item_name: str):
    ensure_user(interaction.user.id)
    conn = get_db()
    c = conn.cursor()
    c.execute("SELECT * FROM shop WHERE name = ?", (item_name,))
    item = c.fetchone()
    if not item:
        return await interaction.response.send_message("‚ùå Item nicht gefunden.", ephemeral=True)
    user = get_user(interaction.user.id)
    if user["coins"] < item["price"]:
        return await interaction.response.send_message("‚ùå Du hast nicht genug Coins.", ephemeral=True)
    c.execute("UPDATE users SET coins = coins - ? WHERE user_id = ?", (item["price"], interaction.user.id))
    c.execute("INSERT OR IGNORE INTO inventory (user_id, item_id, amount) VALUES (?, ?, 0)", (interaction.user.id, item["item_id"]))
    c.execute("UPDATE inventory SET amount = amount + 1 WHERE user_id = ? AND item_id = ?", (interaction.user.id, item["item_id"]))
    conn.commit()
    conn.close()
    await interaction.response.send_message(f"‚úÖ Du hast {item_name} gekauft!")

@tree.command(name="inventory", description="Zeigt dein Inventar an", guild=discord.Object(id=GUILD_ID))
async def inventory(interaction: discord.Interaction):
    ensure_user(interaction.user.id)
    conn = get_db()
    c = conn.cursor()
    c.execute("""
    SELECT shop.name, inventory.amount FROM inventory
    JOIN shop ON inventory.item_id = shop.item_id
    WHERE inventory.user_id = ?
    """, (interaction.user.id,))
    items = c.fetchall()
    embed = discord.Embed(title=f"{interaction.user.display_name} Inventar", color=discord.Color.blue())
    if not items:
        embed.description = "üì¶ Dein Inventar ist leer"
    else:
        for item in items:
            embed.add_field(name=item["name"], value=f"Anzahl: {item['amount']}", inline=False)
    await interaction.response.send_message(embed=embed)

# --------------- Leaderboard -----------------
@tree.command(name="leaderboard", description="Zeigt das Level/Coins Leaderboard", guild=discord.Object(id=GUILD_ID))
async def leaderboard(interaction: discord.Interaction):
    conn = get_db()
    c = conn.cursor()
    c.execute("SELECT * FROM users ORDER BY coins DESC LIMIT 10")
    users = c.fetchall()
    embed = discord.Embed(title="üèÜ Top 10 Coins", color=discord.Color.gold())
    for idx, u in enumerate(users, start=1):
        user = bot.get_user(u["user_id"])
        embed.add_field(name=f"{idx}. {user.display_name if user else u['user_id']}", value=f"{u['coins']} Coins", inline=False)
    await interaction.response.send_message(embed=embed)

# --------------- Minecraft-Dashboard -----------------
@tree.command(name="mcstatus", description="Zeigt den Status des Minecraft-Servers", guild=discord.Object(id=GUILD_ID))
async def mcstatus(interaction: discord.Interaction):
    server = MinecraftServer(MC_IP, MC_PORT)
    try:
        status = server.status()
        embed = discord.Embed(title=f"Minecraft Server Status", color=discord.Color.green())
        embed.add_field(name="IP", value=f"{MC_IP}:{MC_PORT}", inline=True)
        embed.add_field(name="Spieler online", value=f"{status.players.online}/{status.players.max}", inline=True)
        embed.add_field(name="Version", value=status.version.name, inline=True)
        await interaction.response.send_message(embed=embed)
    except:
        embed = discord.Embed(title="Minecraft Server Status", description="Server offline ‚ùå", color=discord.Color.red())
        await interaction.response.send_message(embed=embed)

# --------------- Start -----------------
if __name__ == "__main__":
    if TOKEN == "DEIN_BOT_TOKEN_HIER":
        print("Bitte setze deinen Bot-Token in Replit Secret DISCORD_TOKEN")
    else:
        bot.run(TOKEN)
